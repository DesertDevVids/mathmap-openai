A=30;\npi360=3.1415926535/360;\nn=floor(r/9)+0.5;\nalpha=360/floor(360/(A/(pi360*(n-0.5)*81)));\norigVal(ra:[(n*A/(alpha*pi360))^0.5,a-a%alpha])


rd=0.9*min(X,Y);
if r>rd then
    rgba:[0,0,0,0]
else
    alpha=300; beta=120; gamma=t*180;
    sa=sin(alpha);
    sb=sin(beta);
    ca=cos(alpha);
    cb=cos(beta);
    theta=a;
    phi=acos(r/rd);
    x0=cos(theta)*cos(phi);
    y0=sin(theta)*cos(phi);
    z0=sin(phi);
    x1=ca*x0+sa*y0;
    z1=-sa*-sb*x0+ca*-sb*y0+cb*z0;
    if z1 >= 0 || 1 then
        y1=cb*-sa*x0+cb*ca*y0+sb*z0
    else
        z1=z1-2*cb*z0;
        y1=cb*-sa*x0+cb*ca*y0-sb*z0
    end;
    theta1=atan(-x1/y1)+(if y1>0 then 90 else 270 end);
    phi1=asin(z1);
    origVal(xy:[((theta1*2+gamma)%360-180)/180*X,-phi1/90*Y])
end

rd=0.9*min(X,Y);
if r>rd then
    rgba:[0,0,0,0]
else
    alpha=300; beta=80; gamma=t*360;
    thetal=100; phil=45;
    sa=sin(alpha);
    sb=sin(beta);
    ca=cos(alpha);
    cb=cos(beta);
    theta=a;
    phi=acos(r/rd);

    diffq=cos(theta-thetal)*cos(phi-phil);

    m0=cos(phi);
    x0=cos(theta)*m0;
    y0=sin(theta)*m0;
    z0=sin(phi);
    x1=ca*x0+sa*y0;
    m1=ca*y0-sa*x0;
    z1=cb*z0-sb*m1;
    y1=cb*m1+sb*z0;
    theta1=atan(-x1/y1)+(if y1>0 then 90 else 270 end);
    phi1=asin(z1);
    p=origVal(xy:[((theta1+gamma)%360-180)/180*X,-phi1/90*Y]);
    p*(1-diffq)+rgba:[1,1,1,1]*diffq
end


# Projection to a sphere with reflection
# Thanks to Herbert Poetzl
rd=0.9*min(X,Y);
if r>rd then
    rgba:[0,0,0,0]
else
    alpha=300; beta=80; gamma=t*360;
    thetal=100; phil=45;
    lv=normalize([1,1,2]);
    sa=sin(alpha);
    sb=sin(beta);
    ca=cos(alpha);
    cb=cos(beta);
    theta=a;
    phi=acos(r/rd);
    m0=cos(phi);
    x0=cos(theta)*m0;
    y0=sin(theta)*m0;
    z0=sin(phi);
    x1=ca*x0+sa*y0;
    m1=ca*y0-sa*x0;
    z1=cb*z0-sb*m1;
    y1=cb*m1+sb*z0;
    diffq=dotp(lv,[x1,y1,z1]);
    theta1=atan(-x1/y1)+(if y1>0 then 90 else 270 end);
    phi1=asin(z1);
    p=origVal(xy:[((theta1+gamma)%360-180)/180*X,-phi1/90*Y]);
    p*(1-diffq)+rgba:[1,1,1,1]*diffq
end

# Thanks to Herbert Poetzl
sl=30;
nx=floor(x/sl-0.5); ny=floor(y/sl-0.5);
alpha=[0,0,0,0];
radii=[0,0,0,0];
phii=[0,0,0,0];
xc=[0,0,0,0];
yc=[0,0,0,0];
nummugls=5;
muglwinkl=360/nummugls/2;
heuslfaktor=sl/2;
i=0; while i < 4 do
    ix=nx+i%2;
    iy=ny+floor(i/2);
    xc=morph(xc,i,(ix+0.5)*sl);
    yc=morph(yc,i,(iy+0.5)*sl);
    alpha=morph(alpha,i,ix*10+iy*5);
    kurde=toRA(xy:[x-xc[i],y-yc[i]])+ra:[0,pmod(alpha[i],360)];
    phii=morph(phii,i,kurde[1]);
    radii=morph(radii,i,heuslfaktor/cos(abs(kurde[1]%(muglwinkl*2)-muglwinkl)));
    i = i + 1
end;
i=0;found=0;
while !found && i<4 do
    heuslkurde=toRA(xy:[x-xc[i],y-yc[i]])+ra:[0,alpha[i]];
    if heuslkurde[0]<radii[i] then
        found = 1
    else
        i=i+1
    end
end;
if i >= 4 then
    rgba:[0,0,1,1]
else
    if heuslkurde[0] < radii[i]-1.5 then
        origVal(toXY(heuslkurde)+xy:[xc[i],yc[i]])
    else
        rgba:[0,0,0,1]
    end
end
